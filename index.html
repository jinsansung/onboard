<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Welcome Day</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #000000;
        --text-main: #ffffff;

        /* 랜덤으로 하나를 골라 --accent 에 적용 예정 */
        --accent-a: #FFFF6C;
        --accent-b: #C87DFF;
        --accent-c: #89BCF8;

        --accent: var(--accent-a);

        --radius-lg: 24px;
        --radius-md: 16px;
        --radius-pill: 999px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        background: var(--bg);
        color: var(--text-main);
        font-family: system-ui, -apple-system, "Pretendard",
          "Noto Sans KR", sans-serif;
        font-weight: 800; /* 전체 볼드 */
      }

      /* 데이터 로딩 전에는 전체 앱 숨김 → FRIEND 깜빡임 방지 */
      body.not-ready .app {
        visibility: hidden;
      }

      .app {
        min-height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 24px;
      }

      .view {
        display: none;
        max-width: 960px;
        width: 100%;
        margin: auto;
        background: #000;
        padding: 48px 32px;
        border-radius: var(--radius-lg);
        min-height: 70vh; /* 버튼 위치 안정화를 위한 최소 높이 */
      }

      .view.active {
        display: flex;
        flex-direction: column;
      }

      .center {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        justify-content: center;
        gap: 40px;
      }

      /* 룰렛 화면에서는 위(질문영역) / 아래(버튼영역) 고정 레이아웃 */
      #rouletteView .center {
        justify-content: space-between;
      }

      .welcome-label {
        font-size: clamp(32px, 4vw, 48px);
        letter-spacing: 0.2em;
        color: var(--accent);
        text-transform: uppercase;
      }

      .welcome-name {
        font-size: clamp(72px, 9vw, 108px);
        color: var(--accent);
        text-transform: uppercase;
      }

      button {
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-weight: 800;
        border-radius: var(--radius-pill);
        padding: 18px 36px;
        font-size: clamp(24px, 3vw, 36px);
        transition: opacity 0.12s ease, transform 0.12s ease;
      }

      button:hover {
        opacity: 0.85;
        transform: translateY(-2px);
      }

      .primary-btn {
        background: var(--accent);
        color: #000;
      }

      .secondary-btn {
        background: #fff;
        color: #000;
      }

      .ghost-btn {
        background: transparent;
        color: var(--accent);
      }

      /* 질문 영역: flex:1로 위쪽 공간을 채우고, 가운데 정렬 */
      .question-area {
        width: 100%;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .question-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* 컨테이너 컬러 제거, 텍스트만 하이라이트 컬러 */
      .question-card {
        background: transparent;
        color: var(--accent);
        width: min(100%, 680px);
        padding: 40px 32px;
        border-radius: 0;
        font-size: clamp(28px, 3vw, 40px);
        font-weight: 800;
        line-height: 1.3;
      }

      /* TRIVIA 한 줄 */
.trivia-line {
  position: fixed;
  bottom: 45px;       /* 화면 하단에서 30px 위 */
  left: 0;
  right: 0;
  text-align: center;
  font-size: clamp(18px, 2vw, 22px); 
  color: #ffffff;
  font-weight: 800;
  z-index: 500;        /* 버튼보다 위 */
  pointer-events: none; /* 클릭 방해 X */
}

      .button-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .hidden {
        display: none !important;
      }

      /* 로딩 화면 전체 */
      .loading-screen {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      /* 점 3개 깜빡이는 애니메이션 */
      .loader {
        display: flex;
        gap: 12px;
      }

      .loader span {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--accent);
        opacity: 0.2;
        animation: loadingBlink 1s infinite ease-in-out;
      }

      .loader span:nth-child(2) {
        animation-delay: 0.15s;
      }
      .loader span:nth-child(3) {
        animation-delay: 0.3s;
      }

      @keyframes loadingBlink {
        0%,
        60%,
        100% {
          opacity: 0.2;
          transform: scale(1);
        }
        30% {
          opacity: 1;
          transform: scale(1.4);
        }
      }
    </style>
  </head>

  <!-- 처음에는 not-ready 상태로 시작 → 데이터 로딩 후 클래스 제거 -->
  <body class="not-ready">
    <!-- 로딩 애니메이션 -->
    <div id="loadingScreen" class="loading-screen">
      <div class="loader">
        <span></span><span></span><span></span>
      </div>
    </div>

    <div class="app">
      <!-- WELCOME -->
      <section id="welcomeView" class="view active">
        <div class="center">
          <div class="welcome-label">WELCOME,</div>
          <div class="welcome-name" id="welcomeName">FRIEND!</div>

          <button id="startBtn" class="primary-btn">시작하기</button>
        </div>
      </section>

      <!-- ROULETTE -->
      <section id="rouletteView" class="view">
        <div class="center">
          <div class="question-area">
            <div class="question-wrap">
              <div id="questionDisplay" class="question-card">
                질문이 돌아갑니다…
              </div>
            </div>
          </div>

          <div class="button-row">
            <button id="stopBtn" class="primary-btn">스탑</button>
            <button id="nextQuestionBtn" class="secondary-btn hidden">질문</button>
            <button id="finishBtn" class="ghost-btn hidden">종료</button>
          </div>
        </div>
      </section>
    </div>
          <div id="triviaLine" class="trivia-line hidden">
                TRIVIA:
          </div>
    <script>
  document.addEventListener("DOMContentLoaded", () => {
    const GAS_URL =
      "https://script.google.com/macros/s/AKfycbxOe3m8PF4-Fo0VBFY8eJYJm9Ues7S7WYE7JLrJ_QiN_u7-2oZk5uGaKNUWUUSRlKvcEQ/exec";

    // ----- 1) ACCENT COLOR: 중복 없이 사용 후, 소진되면 다시 리셋 -----
    const colorPool = ["#FFFF6C", "#C87DFF", "#89BCF8"];
    let remainingColors = colorPool.slice();

    function applyRandomAccent() {
      // 다 썼으면 풀 리셋
      if (!remainingColors.length) {
        remainingColors = colorPool.slice();
      }
      const idx = Math.floor(Math.random() * remainingColors.length);
      const color = remainingColors.splice(idx, 1)[0];
      document.documentElement.style.setProperty("--accent", color);
    }

    // 최초 한 번 컬러 적용
    applyRandomAccent();

    const bodyEl = document.body;

    const welcomeView = document.getElementById("welcomeView");
    const rouletteView = document.getElementById("rouletteView");

    const welcomeNameEl = document.getElementById("welcomeName");
    const startBtn = document.getElementById("startBtn");

    const questionDisplay = document.getElementById("questionDisplay");
    const triviaLine = document.getElementById("triviaLine");
    const stopBtn = document.getElementById("stopBtn");
    const nextQuestionBtn = document.getElementById("nextQuestionBtn");
    const finishBtn = document.getElementById("finishBtn");
    const loadingScreen = document.getElementById("loadingScreen");

    let questions = [];
    let remainingQuestions = []; // 아직 안 나온 질문들

    let trivias = [];
    let remainingTrivias = []; // 아직 안 나온 트리비아들

    let isRotating = false;
    let rotationTimer = null;
    let currentQuestion = null; // 지금 룰렛에서 마지막으로 보여준 질문

    function showView(view) {
      welcomeView.classList.remove("active");
      rouletteView.classList.remove("active");
      if (view === "welcome") welcomeView.classList.add("active");
      if (view === "roulette") rouletteView.classList.add("active");
    }

    function setWelcomeName(name) {
      const d = (name || "").trim().toUpperCase() || "FRIEND";
      welcomeNameEl.textContent = d + "!";
    }

    function hideTrivia() {
      triviaLine.classList.add("hidden");
    }

    // ----- 2) TRIVIA: 중복 없이 사용 후, 소진되면 다시 리셋 -----
    function showRandomTrivia() {
      if (!trivias.length) {
        triviaLine.classList.add("hidden");
        return;
      }

      // 남은 트리비아가 없으면 전체 리셋
      if (!remainingTrivias.length) {
        remainingTrivias = trivias.slice();
      }

      const idx = Math.floor(Math.random() * remainingTrivias.length);
      const trivia = remainingTrivias.splice(idx, 1)[0];

      triviaLine.textContent = "TRIVIA: " + trivia;
      triviaLine.classList.remove("hidden");
    }

    // ----- 3) 질문 룰렛: remainingQuestions에서만 랜덤, 소진되면 다시 리셋 -----
    function startRotation() {
      // 질문 자체가 하나도 없을 때
      if (!questions.length) {
        questionDisplay.textContent = "등록된 질문이 없습니다.";
        stopBtn.classList.add("hidden");
        nextQuestionBtn.classList.add("hidden");
        finishBtn.classList.remove("hidden");
        hideTrivia();
        return;
      }

      // 남은 질문이 없으면 전체 풀 리셋
      if (!remainingQuestions.length) {
        remainingQuestions = questions.slice();
      }

      if (isRotating) return;

      isRotating = true;
      stopBtn.classList.remove("hidden");
      nextQuestionBtn.classList.add("hidden");
      finishBtn.classList.add("hidden");
      hideTrivia();

      rotationTimer = setInterval(() => {
        const idx = Math.floor(Math.random() * remainingQuestions.length);
        currentQuestion = remainingQuestions[idx];
        questionDisplay.textContent = currentQuestion;
      }, 70);
    }

    function stopRotation() {
      if (!isRotating) return;
      isRotating = false;
      clearInterval(rotationTimer);

      // 멈춘 시점의 currentQuestion 을 remainingQuestions 에서 제거
      if (currentQuestion) {
        const removeIdx = remainingQuestions.indexOf(currentQuestion);
        if (removeIdx > -1) {
          remainingQuestions.splice(removeIdx, 1);
        }
      }

      stopBtn.classList.add("hidden");
      nextQuestionBtn.classList.remove("hidden");
      finishBtn.classList.remove("hidden");

      // 로테이팅 멈춘 후에는 트리비아 표시
      showRandomTrivia();
    }

    function resetRotation() {
      clearInterval(rotationTimer);
      isRotating = false;
      stopBtn.classList.add("hidden");
      nextQuestionBtn.classList.add("hidden");
      finishBtn.classList.add("hidden");
      hideTrivia();

      // 질문 풀 리셋
      remainingQuestions = questions.slice();
      currentQuestion = null;
      questionDisplay.textContent = "질문이 돌아갑니다…";
    }

    // ----- 4) Google Sheet 연동 -----
    function loadData() {
      const currentUrl = new URL(window.location.href);
      const nameParam = currentUrl.searchParams.get("name") || "";

      const apiUrl = new URL(GAS_URL);
      apiUrl.searchParams.set("mode", "data");
      if (nameParam) apiUrl.searchParams.set("name", nameParam);

      fetch(apiUrl.toString())
        .then((res) => res.json())
        .then((data) => {
          setWelcomeName(data.name);

          questions = Array.isArray(data.questions) ? data.questions : [];
          trivias = Array.isArray(data.trivia) ? data.trivia : [];

          // 남은 질문 / 트리비아 풀 초기화
          remainingQuestions = questions.slice();
          remainingTrivias = trivias.slice();

          bodyEl.classList.remove("not-ready");
          loadingScreen.style.display = "none";
          console.log("Loaded questions:", questions.length);
        })
        .catch((err) => {
          console.log("Fetch error:", err);
          setWelcomeName("FRIEND");
          questions = [];
          trivias = [];
          remainingQuestions = [];
          remainingTrivias = [];

          bodyEl.classList.remove("not-ready");
          loadingScreen.style.display = "none";
        });
    }

    // ----- 5) 이벤트 바인딩 -----
    startBtn.addEventListener("click", () => {
      applyRandomAccent();          // 색도 중복 없이 순환
      showView("roulette");
      remainingQuestions = questions.slice(); // 새 게임 느낌으로 리셋
      questionDisplay.textContent = "질문이 돌아갑니다…";
      startRotation();
    });

    stopBtn.addEventListener("click", () => {
      stopRotation();
    });

    nextQuestionBtn.addEventListener("click", () => {
      applyRandomAccent();          // 리롤 때마다 색 변경 (중복 없이)
      startRotation();
    });

    finishBtn.addEventListener("click", () => {
      applyRandomAccent();
      resetRotation();
      showView("welcome");
    });

    // 최초 로드
    loadData();
  });
</script>
  </body>
</html>
